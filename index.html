<!DOCTYPE html>
<html>
<head>
  <title>ESP32 RGB & Brightness Control</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>

<body style="text-align:center; font-family:Arial; background-color:black; color:white;">

<h1>RGB & Brightness Control</h1>

<!-- Brightness -->
<input type="range" id="sliderBrightness" min="0" max="100" value="0"
       style="width:300px; accent-color:white;">
<p>Brightness: <span id="valBrightness">0</span>%</p>

<!-- Red -->
<input type="range" id="sliderR" min="0" max="100" value="0"
       style="width:300px; accent-color:red;">
<p>Red: <span id="valR">0</span>%</p>

<!-- Green -->
<input type="range" id="sliderG" min="0" max="100" value="0"
       style="width:300px; accent-color:green;">
<p>Green: <span id="valG">0</span>%</p>

<!-- Blue -->
<input type="range" id="sliderB" min="0" max="100" value="0"
       style="width:300px; accent-color:blue;">
<p>Blue: <span id="valB">0</span>%</p>

<!-- Color preview boxes -->
<p>Set Color (Web)</p>
<div id="setColor" style="width:120px;height:120px;border:2px solid white;margin:auto;"></div>

<p>ESP32 Feedback Color</p>
<div id="fbColor" style="width:120px;height:120px;border:2px solid white;margin:auto;"></div>

<script>
  // ---- DOM ----
  const sliderBrightness = document.getElementById("sliderBrightness");
  const sliderR = document.getElementById("sliderR");
  const sliderG = document.getElementById("sliderG");
  const sliderB = document.getElementById("sliderB");

  const valBrightness = document.getElementById("valBrightness");
  const valR = document.getElementById("valR");
  const valG = document.getElementById("valG");
  const valB = document.getElementById("valB");

  const setColorBox = document.getElementById("setColor");
  const fbColorBox  = document.getElementById("fbColor");

  // ---- ESP32 STATE (REAL FEEDBACK) ----
  let esp_brt = 0, esp_r = 0, esp_g = 0, esp_b = 0;

  // ---- MQTT ----
  const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt", {
    clientId: "WebClient_JSON_" + Math.floor(Math.random() * 10000)
  });

  client.on("connect", () => {
    console.log("Connected to MQTT");
    client.subscribe("pranav/esp32/rgb/status/json");
  });

  // ---- ESP32 → WEB (JSON Feedback) ----
  client.on("message", (topic, message) => {
    const data = JSON.parse(message.toString());

    esp_brt = Math.round((data.brt / 4095) * 100);
    esp_r   = Math.round((data.r   / 4095) * 100);
    esp_g   = Math.round((data.g   / 4095) * 100);
    esp_b   = Math.round((data.b   / 4095) * 100);

    sliderBrightness.value = esp_brt;
    sliderR.value = esp_r;
    sliderG.value = esp_g;
    sliderB.value = esp_b;

    valBrightness.innerText = esp_brt;
    valR.innerText = esp_r;
    valG.innerText = esp_g;
    valB.innerText = esp_b;

    updateFeedbackColor();   // REAL ESP32 COLOR
  });

  // ---- WEB → ESP32 (JSON Command) ----
  function publishJSON() {
    const payload = {
      brt: Math.round((sliderBrightness.value / 100) * 4095),
      r:   Math.round((sliderR.value / 100) * 4095),
      g:   Math.round((sliderG.value / 100) * 4095),
      b:   Math.round((sliderB.value / 100) * 4095)
    };

    client.publish(
      "pranav/esp32/rgb/cmd/json",
      JSON.stringify(payload)
    );
  }

  [sliderBrightness, sliderR, sliderG, sliderB].forEach(sl => {
    sl.oninput = () => {
      valBrightness.innerText = sliderBrightness.value;
      valR.innerText = sliderR.value;
      valG.innerText = sliderG.value;
      valB.innerText = sliderB.value;

      publishJSON();
      updateSetColor();   // WEB color only
    };
  });

  // ---- COLOR LOGIC (UNCHANGED MATH) ----
  function updateSetColor() {
    const brt = sliderBrightness.value / 100;

    const r = Math.round(sliderR.value * 2.55 * brt);
    const g = Math.round(sliderG.value * 2.55 * brt);
    const b = Math.round(sliderB.value * 2.55 * brt);

    setColorBox.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
  }

  function updateFeedbackColor() {
    const brt = esp_brt / 100;

    const r = Math.round(esp_r * 2.55 * brt);
    const g = Math.round(esp_g * 2.55 * brt);
    const b = Math.round(esp_b * 2.55 * brt);

    fbColorBox.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
  }
</script>

</body>
</html>
