<!DOCTYPE html>
<html>
<head>
  <title>ESP32 RGB Secure Control</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>

<body style="background:black;color:white;text-align:center;font-family:Arial">

<h2>ESP32 Secure RGB Control</h2>

<!-- LOGIN -->
<div id="loginBox">
  <input id="uid" placeholder="Username"><br><br>
  <input id="pwd" type="password" placeholder="Password"><br><br>
  <button onclick="login()">Login</button>
</div>

<!-- CONTROL -->
<div id="controlBox" style="display:none;">
  <h3>Controls</h3>
  Brightness <input type="range" min="0" max="4095" oninput="sendCmd('BRT', this.value)"><br><br>
  R <input type="range" min="0" max="4095" oninput="sendCmd('R', this.value)"><br><br>
  G <input type="range" min="0" max="4095" oninput="sendCmd('G', this.value)"><br><br>
  B <input type="range" min="0" max="4095" oninput="sendCmd('B', this.value)">
</div>

<script>
/* ===== MQTT CONFIG ===== */
const broker = "wss://broker.hivemq.com:8884/mqtt";
const client = mqtt.connect(broker);

/* ===== TOPICS ===== */
const T_LOGIN = "esp32/rgb/auth/login";
const T_RESP  = "esp32/rgb/auth/resp";
const T_CMD   = "esp32/rgb/cmd";
const T_ACK   = "esp32/rgb/ack";

/* ===== STATE ===== */
let esp_sid = "";
let nonce = 1;

/* ===== MQTT EVENTS ===== */
client.on("connect", () => {
  console.log("MQTT Connected");
  client.subscribe(T_RESP);
  client.subscribe(T_ACK);
});

client.on("message", (topic, message) => {
  const msg = JSON.parse(message.toString());

  if (topic === T_RESP) {
    esp_sid = msg.esp_sid;
    document.getElementById("loginBox").style.display = "none";
    document.getElementById("controlBox").style.display = "block";
    alert("Login successful");
  }

  if (topic === T_ACK) {
    console.log("ACK:", msg);
  }
});

/* ===== LOGIN ===== */
function login() {
  const payload = {
    uid: document.getElementById("uid").value,
    pwd: document.getElementById("pwd").value,
    nonce: nonce++,
    ts: Math.floor(Date.now() / 1000)
  };
  client.publish(T_LOGIN, JSON.stringify(payload));
}

/* ===== SEND COMMAND ===== */
function sendCmd(cmd, val) {
  if (!esp_sid) return;

  const payload = {
    esp_sid: esp_sid,
    cmd: cmd,
    val: parseInt(val),
    nonce: nonce++,
    ts: Math.floor(Date.now() / 1000)
  };
  client.publish(T_CMD, JSON.stringify(payload));
}
</script>

</body>
</html>
