<!DOCTYPE html>
<html>
<head>
  <title>ESP32 RGB & Brightness Control</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>

<body style="text-align:center; font-family:Arial; background-color:black; color:white;">

<!-- ---------- LOGIN OVERLAY (ADDED) ---------- -->
<div id="loginOverlay" style="
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:black;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
">
  <div>
    <h2>Login</h2>
    <input id="username" placeholder="Username"><br><br>
    <input id="password" type="password" placeholder="Password"><br><br>
    <button onclick="login()">Login</button>
    <p id="loginMsg" style="color:red;"></p>
  </div>
</div>

<h1>RGB & Brightness Control</h1>

<!-- Brightness -->
<input type="range" id="sliderBrightness" min="0" max="100" value="0" style="width:300px; accent-color:white;">
<p>Brightness: <span id="valBrightness">0</span>%</p>

<!-- Red -->
<input type="range" id="sliderR" min="0" max="100" value="0" style="width:300px; accent-color:red;">
<p>Red: <span id="valR">0</span>%</p>

<!-- Green -->
<input type="range" id="sliderG" min="0" max="100" value="0" style="width:300px; accent-color:green;">
<p>Green: <span id="valG">0</span>%</p>

<!-- Blue -->
<input type="range" id="sliderB" min="0" max="100" value="0" style="width:300px; accent-color:blue;">
<p>Blue: <span id="valB">0</span>%</p>

<!-- Color preview boxes -->
<p>Set Color (Web)</p>
<div id="setColor" style="width:120px;height:120px;border:2px solid white;margin:auto;"></div>

<p>ESP32 Feedback Color</p>
<div id="fbColor" style="width:120px;height:120px;border:2px solid white;margin:auto;"></div>

<script>
  /* ---------- AUTH CONFIG (ADDED) ---------- */
  const SESSION_TIMEOUT_MIN = 5;
  let isAuthenticated = false;
  let sessionTimer = null;

  function login() {
    const u = username.value;
    const p = password.value;

    if (u === "admin" && p === "admin123") {
      isAuthenticated = true;
      loginOverlay.style.display = "none";

      sessionTimer = setTimeout(() => {
        isAuthenticated = false;
        loginOverlay.style.display = "flex";
        loginMsg.innerText = "Session expired";
      }, SESSION_TIMEOUT_MIN * 60 * 1000);
    } else {
      loginMsg.innerText = "Invalid credentials";
    }
  }

  // ---- DOM Elements ----
  const sliderBrightness = document.getElementById("sliderBrightness");
  const valBrightness = document.getElementById("valBrightness");

  const sliderR = document.getElementById("sliderR");
  const valR = document.getElementById("valR");

  const sliderG = document.getElementById("sliderG");
  const valG = document.getElementById("valG");

  const sliderB = document.getElementById("sliderB");
  const valB = document.getElementById("valB");

  const setColorBox = document.getElementById("setColor");
  const fbColorBox = document.getElementById("fbColor");

  // ---- MQTT Client ----
  const client = mqtt.connect("wss://broker.hivemq.com:8884/mqtt", {
    clientId: "WebClient_" + Math.floor(Math.random() * 10000)
  });

  // ---- On Connect ----
  client.on("connect", () => {
    console.log("Connected to MQTT");

    client.subscribe("pranav/esp32/rgb/status/brightness");
    client.subscribe("pranav/esp32/rgb/status/r");
    client.subscribe("pranav/esp32/rgb/status/g");
    client.subscribe("pranav/esp32/rgb/status/b");
  });

  // ---- ESP32 Feedback ----
  client.on("message", (topic, message) => {
    const pwm = parseInt(message.toString());
    const percent = Math.round((pwm / 4095) * 100);

    if (topic === "pranav/esp32/rgb/status/brightness") {
      sliderBrightness.value = percent;
      valBrightness.innerText = percent;
    }
    else if (topic === "pranav/esp32/rgb/status/r") {
      sliderR.value = percent;
      valR.innerText = percent;
    }
    else if (topic === "pranav/esp32/rgb/status/g") {
      sliderG.value = percent;
      valG.innerText = percent;
    }
    else if (topic === "pranav/esp32/rgb/status/b") {
      sliderB.value = percent;
      valB.innerText = percent;
    }

    updateFeedbackColor();
  });

  // ---- Slider Handlers (Web â†’ ESP32) ----
  sliderBrightness.oninput = () => {
    if (!isAuthenticated) return;
    valBrightness.innerText = sliderBrightness.value;
    const pwm = Math.round((sliderBrightness.value / 100) * 4095);
    client.publish("pranav/esp32/rgb/cmd/brightness", pwm.toString());
    updateSetColor();
  };

  sliderR.oninput = () => {
    if (!isAuthenticated) return;
    valR.innerText = sliderR.value;
    const pwm = Math.round((sliderR.value / 100) * 4095);
    client.publish("pranav/esp32/rgb/cmd/r", pwm.toString());
    updateSetColor();
  };

  sliderG.oninput = () => {
    if (!isAuthenticated) return;
    valG.innerText = sliderG.value;
    const pwm = Math.round((sliderG.value / 100) * 4095);
    client.publish("pranav/esp32/rgb/cmd/g", pwm.toString());
    updateSetColor();
  };

  sliderB.oninput = () => {
    if (!isAuthenticated) return;
    valB.innerText = sliderB.value;
    const pwm = Math.round((sliderB.value / 100) * 4095);
    client.publish("pranav/esp32/rgb/cmd/b", pwm.toString());
    updateSetColor();
  };

  // ---- Color Update Functions ----
  function updateSetColor() {
    const brt = sliderBrightness.value / 100;

    const r = Math.round(sliderR.value * 2.55 * brt);
    const g = Math.round(sliderG.value * 2.55 * brt);
    const b = Math.round(sliderB.value * 2.55 * brt);

    setColorBox.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
  }

  function updateFeedbackColor() {
    const brt = sliderBrightness.value / 100;

    const r = Math.round(sliderR.value * 2.55 * brt);
    const g = Math.round(sliderG.value * 2.55 * brt);
    const b = Math.round(sliderB.value * 2.55 * brt);

    fbColorBox.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
  }
</script>

</body>
</html>
